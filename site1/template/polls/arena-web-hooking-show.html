{% load static %}

<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Bem-vindo ao meu projeto {% block title %}{% endblock %}</title>

  <!-- Bootstrap core CSS -->
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'css/main.css' %}" rel="stylesheet">
  <link href="{% static 'css/dashboard.css' %}" rel="stylesheet">

  <style>
    body {
      padding-top: 56px;
    }
    table {
      font-size: 0.9rem;
    }
  </style>
</head>

<body>

  <!-- Navbar fixa no topo -->
  <nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow">
    {% include 'partials/navbar.html' %}
  </nav>

  <div class="container-fluid">
    <div class="row">

      <!-- Sidebar -->
      <!-- {% include 'partials/sidebar.html' %} -->

      <!-- Conteúdo principal -->
      <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4 pt-4">
  <h2 class="text-center mb-4">Lutas (Atualização Automática)</h2>

  <div class="table-responsive">
    <table id="lutas-tabela" class="table table-hover table-bordered align-middle">
      <thead class="table-dark text-center">
        <tr>
          <th>Match #</th>
          <th>Mat</th>
          <th>Categoria</th>
          <th>Round</th>
          <th>Atleta 1</th>
          <th>Atleta 2</th>
          <th>Ganhador</th>
          <th>Resultado</th>
          <th>Início</th>
          <th>Fim</th>
        </tr>
      </thead>
      <tbody id="lutas-body"></tbody>
    </table>
  </div>

  {% block content %}{% endblock %}
</main>

<script>
  function formatDateTime(datetimeStr) {
    if (!datetimeStr) return "";
    const dt = new Date(datetimeStr);
    return dt.toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" });
  }

  function flagIcon(flagValue) {
    return flagValue === 1 ? "✅" : "❌";
  }

  function carregarLutas() {
    fetch('/lutas-json/')
      .then(response => response.json())
      .then(data => {
        const corpoTabela = document.getElementById('lutas-body');
        corpoTabela.innerHTML = '';
        data.lutas.forEach(luta => {
          const linha = document.createElement('tr');

          // destacar o ganhador
          const atleta1 = `
            <div class="${luta.id_atleta_ganhador === luta.id_atleta1 ? 'fw-bold text-success' : ''}">
              ID: ${luta.id_atleta1} <br>
              Rank: ${luta.atleta1_draw_rank || '-'}
              ${flagIcon(luta.atleta1_flag_injured)}
              ${flagIcon(luta.atleta1_flag_seeded)}
            </div>`;

          const atleta2 = `
            <div class="${luta.id_atleta_ganhador === luta.id_atleta2 ? 'fw-bold text-success' : ''}">
              ID: ${luta.id_atleta2} <br>
              Rank: ${luta.atleta2_draw_rank || '-'}
              ${flagIcon(luta.atleta2_flag_injured)}
              ${flagIcon(luta.atleta2_flag_seeded)}
            </div>`;

          linha.innerHTML = `
            <td class="text-center">${luta.numero || ''}</td>
            <td class="text-center">${luta.tapete}</td>
            <td>
              ${luta.audienceName}<br>
              <small>${luta.sportAlternateName} - ${luta.weightCategoryName}</small>
            </td>
            <td class="text-center">${luta.round}</td>
            <td>${atleta1}</td>
            <td>${atleta2}</td>
            <td class="text-center fw-bold">${luta.id_atleta_ganhador || '-'}</td>
            <td class="text-center">
              ${luta.resultado || ''}
              <br><small>${luta.tipo_vitoria || ''}</small>
            </td>
            <td>${formatDateTime(luta.data_inicio)}</td>
            <td>${formatDateTime(luta.data_fim)}</td>
          `;
          corpoTabela.appendChild(linha);
        });
      });
  }

  carregarLutas();
  setInterval(carregarLutas, 5000);
</script>

  <!-- Bibliotecas externas -->
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.9.0/dist/feather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.7.3/dist/Chart.min.js"></script>
  <script src="{% static 'js/main.js' %}"></script>

</body>
</html>
